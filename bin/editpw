#!/usr/bin/env python

from pw.core import Cli, CliHelper
import random
import re
import string


class EditPwHelper(CliHelper):

    def process_input(self, cli_input, name):

        # This loop allows the user to cancel out before saving and start over.
        done = False

        while not done:

            if name not in self.cli.data:
                action = 'Creating'
                name = cli_input
                cur = {}
                for field in self.cli.fields:
                    cur[field] = ''
            else:
                action = 'Editing'
                cur = self.cli.data[name].copy()

            print '{} credential "{}"'. format(action, name)
            for field in self.cli.fields:
                suggested_pw = None
                if action == 'Creating':
                    if field == 'password':
                        myrg = random.SystemRandom()
                        length = 10
                        alphabet = string.letters[0:52] + string.digits
                        suggested_pw = str().join(myrg.choice(alphabet)
                                                  for _ in range(length))
                        cur_text = ' [{}]'.format(suggested_pw)
                    else:
                        cur_text = ''
                elif field not in cur:
                    cur_text = ''
                else:
                    cur_text = ' [{}]'.format(cur[field])

                new_value = raw_input('{}{}: '.format(field, cur_text))
                if new_value != '':
                    cur[field] = new_value
                elif action == 'Creating' and field == 'password':
                    cur[field] = suggested_pw

            if (re.search('^y?$', raw_input('OK? [Y/n] '), re.I)):
                self.cli.data[name] = cur
                self.cli.save()
                done = True

#
# Main program
#
parser = Cli.create_arg_parser('Edit or create credentials.')
args = parser.parse_args()
cli = Cli(args.pw_file)
cli.run('edit', EditPwHelper, args.credential_name)
