#!/usr/bin/env python

import argparse
import getpass
import nacl.exceptions
from pw.core import Cli
import random
import re
import string


def lookup_credential(cli, search_term):

    cli.load()
    name = cli.lookup_credential_for_edit(search_term)
    done = False

    # This loop allows the user to cancel out before saving and start over.
    while not done:

        if name not in cli.pw_data:
            action = 'Creating'
            cur = {}
            for field in cli.fields:
                cur[field] = ''
        else:
            action = 'Editing'
            cur = cli.pw_data[name].copy()

        print '{} credential "{}"'. format(action, name)
        for field in cli.fields:
            suggested_pw = None
            if action == 'Creating':
                if field == 'password':
                    myrg = random.SystemRandom()
                    length = 10
                    alphabet = string.letters[0:52] + string.digits
                    suggested_pw = str().join(myrg.choice(alphabet)
                                              for _ in range(length))
                    cur_text = ' [{}]'.format(suggested_pw)
                else:
                    cur_text = ''
            elif field not in cur:
                cur_text = ''
            else:
                cur_text = ' [{}]'.format(cur[field])

            new_value = raw_input('{}{}: '.format(field, cur_text))
            if new_value != '':
                cur[field] = new_value
            elif action == 'Creating' and field == 'password':
                cur[field] = suggested_pw

        if (re.search('^y?$', raw_input('OK? [Y/n] '), re.I)):
            cli.pw_data[name] = cur
            cli.save()
            done = True


parser = argparse.ArgumentParser(
    description='Edit or create password.')

parser.add_argument('pw_file', help='password list')
parser.add_argument('credential_name', nargs='?', default=None,
                    help='name of credential (if not specified, command '
                    'will prompt.')
args = parser.parse_args()

try:
    cli = Cli(args.pw_file, getpass.getpass())

    if args.credential_name is None:
        cli.prompt_loop('editpw', lookup_credential)
    else:
        lookup_credential(cli, args.credential_name)

except (IOError, nacl.exceptions.CryptoError) as e:
    print e

except (KeyboardInterrupt, EOFError):
    print
